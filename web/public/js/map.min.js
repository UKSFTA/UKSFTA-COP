document.addEventListener("DOMContentLoaded",()=>{const a=document.querySelector('meta[name="supabase-url"]').content,r=document.querySelector('meta[name="supabase-service-role-key"]').content;let t="",e,o,i=!1;const n=e=>console.log(`%c[UKSFTA-DIAG]%c ${e}`,"color: #ff9800; font-weight: bold","color: #e0e0e0");function s(i){if(!i)return;const r=i.toLowerCase();if(typeof window.Arma3Map=="undefined"||!window.Arma3Map.Maps){n("Registry not found, retrying..."),setTimeout(()=>s(r),200);return}const a=Arma3Map.Maps[r]||Arma3Map.Maps.dagger_island;if(!a){n("CRITICAL: No Maps Registered!");return}if(t===a.worldName)return;t=a.worldName,n(`DIAGNOSTIC BOOT: ${t.toUpperCase()}`),e&&(e.remove(),e=null),e=L.map("map",{crs:L.CRS.Simple,minZoom:-5,maxZoom:10,zoomControl:!0,attributionControl:!1});const c=[-(a.worldSize/2),a.worldSize/2];e.setView(c,a.defaultZoom||2),L.marker(c).addTo(e).bindTooltip("DIAGNOSTIC ANCHOR: MAP CENTER",{permanent:!0}).openTooltip(),o=L.tileLayer(`/theatre/${t}/{z}/{x}/{y}.png`,{minZoom:-10,maxZoom:10,maxNativeZoom:a.maxNativeZoom||5,tileSize:256,noWrap:!0}).addTo(e),o.on("tileload",e=>n(`Tile Success: ${e.url}`)),o.on("tileerror",e=>console.error(`Tile 404: ${e.url}`)),setTimeout(()=>e.invalidateSize(),100),setTimeout(()=>e.invalidateSize(),1e3)}async function c(){if(!a||i)return;i=!0;try{const o=await fetch(`${a}/rest/v1/live_session?select=world_name&id=eq.1`,{headers:{apikey:r,Authorization:`Bearer ${r}`}}),e=await o.json();if(e.length>0){const o=e[0].world_name.toLowerCase();t!==o&&!o.startsWith(t)&&(n(`Sync Trigger: ${o}`),s(o))}}catch{}i=!1}window.changeTheatre=e=>s(e),s("dagger_island"),setInterval(c,5e3)})